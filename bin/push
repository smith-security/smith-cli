#!/bin/sh -eu

VERSION="0.0.1"
STAMP="$VERSION-$(date "+%Y%m%d%H%M%S")-$(git log --pretty=format:%h -n 1)"
: ${PLATFORM:=debian/stretch}
: ${BRANCH:=$BUILDKITE_BRANCH}
: ${BUILD_NUMBER:=BUILDKITE_BUILD_NUMBER}

for EXECUTABLE in smith smith-host; do
    TARGET="dist/build/$EXECUTABLE/$EXECUTABLE"
    SOURCE="$(cat publish/$EXECUTABLE)"
    mkdir -p "$(dirname "$TARGET")"
    aws s3 cp "$SOURCE" "$TARGET"
done

docker build \
    -t "smithsecurity/smith-cli:$BUILD_NUMBER" \
    -t smithsecurity/smith-cli:latest .
DOCKER_USERNAME=$(./bin/fetch-secret "build/DOCKER_USERNAME")
DOCKER_PASSWORD=$(./bin/fetch-secret "build/DOCKER_PASSWORD")
docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
docker push "smithsecurity/smith-cli:$BUILD_NUMBER"
docker push smithsecurity/smith-cli:latest
